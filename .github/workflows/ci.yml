name: CI

on:
  push:
  pull_request:

jobs:
  whenreset:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          # Keep CI deterministic; avoid breakage from newly released Python majors/minors.
          python-version: '3.13'

      - name: Install test dependencies
        run: python -m pip install --upgrade pip pytest

      - name: Run pytest unit tests
        run: python -m pytest -q

      - name: Ensure script is executable
        run: chmod +x gh-whenreset

      - name: Default mode picks latest exhausted bucket
        run: |
          output="$(./gh-whenreset --tz UTC < fixtures/exhausted.json)"
          echo "$output"
          echo "$output" | grep -q $'\\tgraphql\\t'
          echo "$output" | grep -Eq '(in [0-9]+(s|min|h|d)|[0-9]+(s|min|h|d) ago)$'

      - name: Default mode exits 2 when no exhausted bucket exists
        run: |
          set +e
          ./gh-whenreset < fixtures/no_exhausted.json >/tmp/out.txt 2>/tmp/err.txt
          code=$?
          set -e
          test "$code" -eq 2
          grep -q "No rate limit buckets matched" /tmp/err.txt

      - name: --all considers all buckets and succeeds
        run: |
          output="$(./gh-whenreset --all --tz UTC < fixtures/no_exhausted.json)"
          echo "$output"
          echo "$output" | grep -q $'\\tsearch\\t'
          echo "$output" | grep -Eq '(in [0-9]+(s|min|h|d)|[0-9]+(s|min|h|d) ago)$'
